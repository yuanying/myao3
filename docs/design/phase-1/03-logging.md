# 03. ログ出力基盤

## 概要

structlog を使用した構造化ログ出力基盤を実装する。JSON 形式で stdout に出力し、Kubernetes 環境との親和性を確保する。

## 依存タスク

- 02-config.md（LoggingConfig を使用）

## 成果物

### ファイル配置

```
src/myao3/infrastructure/logging/
├── __init__.py
└── setup.py      # ログ設定
```

### ログ設定機能

**設定項目:**

| 項目 | 設定値 | 説明 |
|------|--------|------|
| フォーマット | JSON | 構造化ログ出力 |
| 出力先 | stdout | K8s との親和性 |
| タイムスタンプ | ISO 8601 | 標準形式 |
| ログレベル | 設定ファイルから取得 | INFO がデフォルト |

**出力フォーマット例:**

```json
{
  "timestamp": "2026-01-16T10:30:00.000000Z",
  "level": "info",
  "event": "Event processed",
  "event_id": "01HXYZ...",
  "event_type": "ping",
  "duration_ms": 150
}
```

### コンテキスト情報の付与

アプリケーション全体で共有するコンテキスト情報を設定可能にする。

**共通コンテキスト:**

| フィールド | 説明 |
|-----------|------|
| service | サービス名（"myao3"） |
| version | アプリケーションバージョン |

**リクエスト単位のコンテキスト:**

| フィールド | 説明 |
|-----------|------|
| event_id | 処理中のイベント ID |
| event_type | イベントタイプ |

### ロガー取得関数

モジュールごとにロガーを取得するユーティリティを提供する。

**使用方法:**

```python
from myao3.infrastructure.logging import get_logger

logger = get_logger(__name__)
logger.info("Processing event", event_id="01HXYZ...")
```

## テストケース

### TC-03-001: JSON 形式でログ出力

**手順:**
1. ログ設定を初期化
2. info レベルのログを出力
3. stdout をキャプチャ

**期待結果:**
- JSON 形式で出力される
- 必須フィールド（timestamp, level, event）が含まれる

### TC-03-002: ログレベルのフィルタリング

**前提条件:** ログレベルが INFO に設定されている

**手順:**
1. DEBUG レベルのログを出力
2. INFO レベルのログを出力

**期待結果:**
- DEBUG ログは出力されない
- INFO ログは出力される

### TC-03-003: コンテキスト情報の付与

**手順:**
1. コンテキストを bind してログ出力
2. 出力された JSON を確認

**期待結果:**
- bind したコンテキストがログに含まれる

### TC-03-004: 例外情報のログ出力

**手順:**
1. 例外をキャッチしてログ出力
2. 出力された JSON を確認

**期待結果:**
- 例外情報（exception フィールド）が含まれる
- スタックトレースが含まれる

### TC-03-005: タイムスタンプ形式

**手順:**
1. ログを出力
2. timestamp フィールドを確認

**期待結果:**
- ISO 8601 形式（例: "2026-01-16T10:30:00.000000Z"）

## 完了条件

- [ ] structlog を使用したログ設定が実装されている
- [ ] JSON 形式で stdout に出力される
- [ ] ログレベルが設定ファイルから読み込まれる
- [ ] コンテキスト情報を付与できる
- [ ] 全てのテストケースがパスする
