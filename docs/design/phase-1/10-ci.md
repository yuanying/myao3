# 10. GitHub Actions CI 設定

## 概要

GitHub Actions を使用した CI ワークフローを設定する。プッシュ・プルリクエスト時に lint、型チェック、テストを自動実行する。

## 依存タスク

- 01-project-setup.md

## 成果物

### ファイル配置

```
.github/
└── workflows/
    └── ci.yaml    # CI ワークフロー設定
```

### ワークフロー設定

**トリガー:**

| イベント | 条件 |
|---------|------|
| push | main ブランチ |
| push | feature/** ブランチ |
| pull_request | main ブランチへの PR |

**ジョブ:**

| ジョブ名 | 説明 |
|---------|------|
| lint | ruff による lint チェック |
| type-check | ty による型チェック |
| test | pytest によるテスト実行 |

### 各ジョブの詳細

**lint:**

| ステップ | コマンド |
|---------|---------|
| Checkout | actions/checkout@v4 |
| Setup Python | actions/setup-python@v5 (3.12) |
| Install uv | astral-sh/setup-uv@v4 |
| Install deps | uv sync |
| Run ruff check | uv run ruff check . |
| Run ruff format | uv run ruff format --check . |

**type-check:**

| ステップ | コマンド |
|---------|---------|
| Checkout | actions/checkout@v4 |
| Setup Python | actions/setup-python@v5 (3.12) |
| Install uv | astral-sh/setup-uv@v4 |
| Install deps | uv sync |
| Run ty | uv run ty check |

**test:**

| ステップ | コマンド |
|---------|---------|
| Checkout | actions/checkout@v4 |
| Setup Python | actions/setup-python@v5 (3.12) |
| Install uv | astral-sh/setup-uv@v4 |
| Install deps | uv sync |
| Run pytest | uv run pytest --cov=src/myao3 --cov-report=xml |
| Upload coverage | codecov/codecov-action@v4 (optional) |

**環境変数:**

| 変数 | 値 | 説明 |
|------|-----|------|
| MOCK_LLM | true | LLM 呼び出しをモック |
| PYTHONPATH | src | モジュールパス設定 |

### ジョブ間の依存関係

```
lint ────────┐
             ├──→ test
type-check ──┘
```

lint と type-check が両方成功した場合のみ test を実行する（オプション）。

または、全ジョブを並列実行してフィードバックを早くする。

### キャッシュ設定

**uv キャッシュ:**

```yaml
- uses: astral-sh/setup-uv@v4
  with:
    enable-cache: true
```

### Python バージョン

| バージョン | 用途 |
|-----------|------|
| 3.12 | メインテスト対象 |

将来的に複数バージョンでテストする場合は matrix を使用。

## テストケース

### TC-10-001: lint ジョブの成功

**前提条件:** コードが ruff のルールに準拠している

**手順:**
1. GitHub に push
2. CI の実行を確認

**期待結果:**
- lint ジョブが成功する

### TC-10-002: lint ジョブの失敗

**前提条件:** ruff エラーが含まれるコード

**手順:**
1. エラーのあるコードを push
2. CI の実行を確認

**期待結果:**
- lint ジョブが失敗する
- エラー内容が表示される

### TC-10-003: type-check ジョブの成功

**前提条件:** 型エラーがない

**手順:**
1. GitHub に push
2. CI の実行を確認

**期待結果:**
- type-check ジョブが成功する

### TC-10-004: type-check ジョブの失敗

**前提条件:** 型エラーが含まれるコード

**手順:**
1. 型エラーのあるコードを push
2. CI の実行を確認

**期待結果:**
- type-check ジョブが失敗する
- エラー内容が表示される

### TC-10-005: test ジョブの成功

**前提条件:**
- 全テストが成功する
- MOCK_LLM=true

**手順:**
1. GitHub に push
2. CI の実行を確認

**期待結果:**
- test ジョブが成功する
- カバレッジレポートが生成される

### TC-10-006: test ジョブの失敗

**前提条件:** テストが失敗するコード

**手順:**
1. 失敗するテストを含むコードを push
2. CI の実行を確認

**期待結果:**
- test ジョブが失敗する
- 失敗したテストが表示される

### TC-10-007: Pull Request での CI 実行

**手順:**
1. feature ブランチを作成
2. main への PR を作成
3. CI の実行を確認

**期待結果:**
- PR に CI の結果が表示される
- 全ジョブが実行される

### TC-10-008: キャッシュの動作

**手順:**
1. 初回 push で CI を実行
2. 2回目の push で CI を実行
3. 実行時間を比較

**期待結果:**
- 2回目は依存関係のインストールがキャッシュされる
- 実行時間が短縮される

## 完了条件

- [ ] .github/workflows/ci.yaml が作成されている
- [ ] push 時に CI が実行される
- [ ] PR 時に CI が実行される
- [ ] lint ジョブが ruff check と ruff format を実行する
- [ ] type-check ジョブが ty check を実行する
- [ ] test ジョブが pytest を実行する
- [ ] MOCK_LLM=true でテストが実行される
- [ ] 全てのテストケースがパスする
