# 07. アプリケーションエントリポイント

## 概要

`python -m myao3` で起動可能なアプリケーションエントリポイントを実装する。設定読み込み、コンポーネント初期化、メインループの実行、グレースフルシャットダウンを担当する。

## 依存タスク

- 06-agent-loop.md
- 08-http-server.md

## 成果物

### ファイル配置

```
src/myao3/
├── __init__.py
└── __main__.py    # エントリポイント
```

### 起動フロー

```
1. コマンドライン引数パース（--config）
2. 設定ファイル読み込み
3. ログ設定初期化
4. コンポーネント初期化
   - EventQueue
   - AgentLoop
   - HTTP サーバー
5. シグナルハンドラ登録（SIGINT, SIGTERM）
6. HTTP サーバー起動
7. メインループ開始
   - EventQueue からイベント取得
   - AgentLoop で処理
   - mark_done で完了記録
8. シャットダウン処理
```

### メインループ

**処理フロー:**

```
while running:
    event = await event_queue.dequeue()
    try:
        await agent_loop.process(event)
    finally:
        event_queue.mark_done(event)
```

**特性:**

- 逐次処理（同時処理なし）
- イベントごとに try/finally で mark_done を保証
- 例外発生時もキューの状態を正しく維持

### グレースフルシャットダウン

**トリガー:**

- SIGINT（Ctrl+C）
- SIGTERM（kill コマンド）

**処理フロー:**

1. running フラグを False に設定
2. HTTP サーバーの新規リクエスト受付を停止
3. 処理中のイベント完了を待機
4. タイムアウト（30秒）で強制終了
5. リソースのクリーンアップ

**タイムアウト設定:**

| 項目 | 値 |
|------|-----|
| シャットダウンタイムアウト | 30秒 |

### 使用例

```bash
# 設定ファイルを指定して起動
python -m myao3 --config config.yaml

# 短縮形
python -m myao3 -c config.yaml
```

## テストケース

### TC-07-001: 正常起動

**前提条件:** 有効な config.yaml が存在する

**手順:**
1. `python -m myao3 --config config.yaml` を実行
2. 起動ログを確認
3. SIGINT で停止

**期待結果:**
- エラーなく起動する
- 起動完了ログが出力される
- グレースフルに停止する

### TC-07-002: 設定ファイルが存在しない場合

**手順:**
1. 存在しないパスを指定して起動

**期待結果:**
- ファイルが見つからないエラーが出力される
- プロセスが終了する（exit code != 0）

### TC-07-003: 設定ファイルが無効な場合

**前提条件:** 無効な YAML ファイルが存在する

**手順:**
1. 無効な設定ファイルを指定して起動

**期待結果:**
- 設定エラーが出力される
- プロセスが終了する

### TC-07-004: SIGINT によるシャットダウン

**前提条件:** アプリケーションが起動中

**手順:**
1. SIGINT を送信
2. 停止処理を確認

**期待結果:**
- シャットダウン開始ログが出力される
- 処理中イベントの完了を待機する
- グレースフルに停止する

### TC-07-005: SIGTERM によるシャットダウン

**前提条件:** アプリケーションが起動中

**手順:**
1. SIGTERM を送信
2. 停止処理を確認

**期待結果:**
- SIGINT と同様にグレースフルに停止する

### TC-07-006: イベント処理中のシャットダウン

**前提条件:**
- アプリケーションが起動中
- イベントを処理中

**手順:**
1. イベントを送信
2. 処理中に SIGINT を送信
3. 停止処理を確認

**期待結果:**
- 処理中のイベントが完了するまで待機する
- 完了後に停止する

### TC-07-007: シャットダウンタイムアウト

**前提条件:**
- アプリケーションが起動中
- 長時間かかるイベントを処理中

**手順:**
1. 長時間イベントを送信
2. SIGINT を送信
3. 30秒以上待機

**期待結果:**
- 30秒後に強制終了する
- タイムアウトログが出力される

### TC-07-008: --config 引数なしでの起動

**手順:**
1. `python -m myao3` を引数なしで実行

**期待結果:**
- 必須引数エラーが出力される
- ヘルプメッセージが表示される

### TC-07-009: 統合テスト - Ping イベント処理

**前提条件:**
- MOCK_LLM=true
- アプリケーションが起動中

**手順:**
1. HTTP で Ping イベントを送信
2. 処理完了を確認
3. SIGINT で停止

**期待結果:**
- Ping イベントが処理される
- ログに処理結果が記録される
- グレースフルに停止する

## 完了条件

- [ ] `python -m myao3 --config config.yaml` で起動できる
- [ ] 設定読み込み → ログ設定 → コンポーネント初期化の順で実行される
- [ ] メインループがイベントを逐次処理する
- [ ] SIGINT/SIGTERM でグレースフルシャットダウンする
- [ ] シャットダウンタイムアウト（30秒）が機能する
- [ ] 全てのテストケースがパスする
